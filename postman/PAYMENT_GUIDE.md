# ЁЯТ░ Payment System Guide

## ЁЯУе Import Collection
`postman/Payment_API.postman_collection.json` ржЯрж┐ Postman ржП Import ржХрж░рзБржиред

## ЁЯФД Workflow (ржХрж┐ржнрж╛ржмрзЗ ржЯрзЗрж╕рзНржЯ ржХрж░ржмрзЗржи)

**Prerequisites:**
1. ржПржХржЯрж┐ **Marketplace Listing** ржерж╛ржХрждрзЗ рж╣ржмрзЗ (`listing_id` environment variable ржП set ржерж╛ржХрж╛ рж▓рж╛ржЧржмрзЗ)ред
   - Marketplace API collection ржерзЗржХрзЗ "List in Marketplace" run ржХрж░рзЗ `listing_id` ржкрзЗрждрзЗ ржкрж╛рж░рзЗржиред
2. **Buyer Token** ржерж╛ржХрждрзЗ рж╣ржмрзЗ (`buyer_token`)ред
   - Seller ржПржмржВ Buyer ржнрж┐ржирзНржи ржЗржЙржЬрж╛рж░ рж╣рждрзЗ рж╣ржмрзЗ!

---

### Step 1: Initiate Payment
`POST /api/payments/initiate`
- ржПржЯрж┐ ржкрзЗржорзЗржирзНржЯ рж╢рзБрж░рзБ ржХрж░ржмрзЗ ржПржмржВ ржПржХржЯрж┐ Pending record рждрзИрж░рж┐ ржХрж░ржмрзЗред
- **Returns:** `paymentId`, `transactionId` (Mock)

### Step 2: Verify Payment
`POST /api/payments/verify`
- ржПржЯрж┐ ржкрзЗржорзЗржирзНржЯ ржХржиржлрж╛рж░рзНржо ржХрж░ржмрзЗред
- **Action:** 
  1. Payment status `completed` рж╣ржмрзЗред
  2. Project ржЯрж┐ `sold` рж╣рж┐рж╕рзЗржмрзЗ ржорж╛рж░рзНржХ рж╣ржмрзЗ (`soldTo` buyer ID ржжрж┐ржпрж╝рзЗ рж╕рзЗржЯ рж╣ржмрзЗ)ред
  3. Marketplace ржерзЗржХрзЗ ржкрзНрж░ржЬрзЗржХрзНржЯржЯрж┐ рж╕рж░рзЗ ржпрж╛ржмрзЗ (ржпрзЗрж╣рзЗрждрзБ `isForSale: false` рж╣ржпрж╝рзЗ ржпрж╛ржмрзЗ)ред

### Step 3: Check History
`GET /api/transactions`
- ржЖржкржирж╛рж░ рж╕ржм ржХрзНрж░рзЯрзЗрж░ рж▓рж┐рж╕рзНржЯ ржжрзЗржЦрждрзЗ ржкрж╛ржмрзЗржиред

---

## тЭУ Troubleshooting (Common Errors)

### ЁЯФ┤ Error: `Cast to ObjectId failed for value "{{order_id}}"`
**ржХрж╛рж░ржг:** Postman `{{order_id}}` ржХрзЗ рж░рж┐ржкрзНрж▓рзЗрж╕ ржХрж░рждрзЗ ржкрж╛рж░ржЫрзЗ ржирж╛ред
**рж╕ржорж╛ржзрж╛ржи рзз (Automated):** 
- ржкрзНрж░ржержорзЗ **Step 1: Create Order** рж░рж╛ржи ржХрж░рзБржиред
- ржПржЯрж┐ ржЕржЯрзЛржорзЗржЯрж┐ржХ `order_id` рж╕рзЗржн ржХрж░ржмрзЗред
- рждрж╛рж░ржкрж░ **Step 2** рж░рж╛ржи ржХрж░рзБржиред

**рж╕ржорж╛ржзрж╛ржи рзи (Manual):**
- Step 1 ржПрж░ рж░рзЗрж╕ржкржирзНрж╕ ржерзЗржХрзЗ `_id` ржХржкрж┐ ржХрж░рзБржи (ржпрзЗржоржи: `65a123...`)ред
- Step 2 ржПрж░ Body рждрзЗ `{{order_id}}` ржорзБржЫрзЗ ржжрж┐рзЯрзЗ рж╕рзЗржЗ ржЖржЗржбрж┐ ржкрзЗрж╕рзНржЯ ржХрж░рзБржиред
```json
{
    "orderId": "65a1234567890abcdef12345",
    "token": "9012930219301"
}
```

### ЁЯФ┤ Error: `Card was declined`
**рж╕ржорж╛ржзрж╛ржи:**
- `token` рж╣рж┐рж╕рзЗржмрзЗ ржЕржмрж╢рзНржпржЗ `9012930219301` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзБржиред ржПржЯрж┐ ржЖржорж╛ржжрзЗрж░ ржЯрзЗрж╕рзНржЯ ржЯрзЛржХрзЗржиред

---

## ЁЯЫая╕П Code Structure Explainer for Beginners

ржЖржорж░рж╛ рзйржЯрж┐ рж▓рзЗржпрж╝рж╛рж░ ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрж┐ ржпрж╛рждрзЗ ржХрзЛржб ржХрзНрж▓рж┐ржи ржерж╛ржХрзЗ:

1. **Model (`Payment.model.js`)**: ржбрзЗржЯрж╛ржмрзЗрж╕ ржбрж┐ржЬрж╛ржЗржиред ржЖржорж░рж╛ `user`, `project`, `amount`, ржПржмржВ `status` рж░рзЗржЦрзЗржЫрж┐ред `transactionId` ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрж┐ ржпрж╛рждрзЗ ржнржмрж┐рж╖рзНржпрждрзЗ Stripe/SSLCommerz ржЗржирзНржЯрж┐ржЧрзНрж░рзЗржЯ ржХрж░рж╛ рж╕рж╣ржЬ рж╣ржпрж╝ред

2. **Controller (`payment.controller.js`)**: 
   - `initiatePayment`: ржкрзНрж░ржержорзЗ ржЪрзЗржХ ржХрж░рж┐ ржкрзНрж░ржЬрзЗржХрзНржЯржЯрж┐ ржмрж┐ржХрзНрж░рж┐рж░ ржЬржирзНржп ржЖржЫрзЗ ржХрж┐ржирж╛ред рждрж╛рж░ржкрж░ Pending ржкрзЗржорзЗржирзНржЯ рждрзИрж░рж┐ ржХрж░рж┐ред
   - `verifyPayment`: ржПржЦрж╛ржирзЗ ржЖржорж░рж╛ **MongoDB Transaction (`session`)** ржмрзНржпржмрж╣рж╛рж░ ржХрж░рзЗржЫрж┐ред ржХрзЗржи? 
     - ржпрж╛рждрзЗ ржЯрж╛ржХрж╛ ржХрж╛ржЯрж╛рж░ ржкрж░ ржкрзНрж░ржЬрзЗржХрзНржЯрзЗрж░ рж╕рзНржЯрзНржпрж╛ржЯрж╛рж╕ ржЖржкржбрзЗржЯ ржирж╛ рж╣рж▓рзЗ ржкрзБрж░рзЛ ржкрзНрж░рж╕рзЗрж╕ рж░рзЛрж▓ржмрзНржпрж╛ржХ рж╣ржпрж╝ред ржПржЯрж┐ ржбрзЗржЯрж╛ ржХржирж╕рж┐рж╕рзНржЯрзЗржирзНрж╕рж┐ ржирж┐рж╢рзНржЪрж┐ржд ржХрж░рзЗред

3. **Routes (`paymentRoutes.js`)**: URL ржЧрзБрж▓рзЛ рж╕рж╛ржЬрж╛ржирзЛ рж╣ржпрж╝рзЗржЫрзЗред

Happy Coding! ЁЯЪА
